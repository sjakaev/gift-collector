<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–±–æ—Ä –Ω–∞ –ø–æ–¥–∞—Ä–∫–∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            font-size: 2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .gift-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .gift-title {
            font-size: 1.4rem;
            color: #333;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gift-title .emoji {
            font-size: 1.6rem;
        }

        .progress-container {
            background: #e9ecef;
            border-radius: 20px;
            height: 36px;
            overflow: hidden;
            position: relative;
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 100%;
            border-radius: 20px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
        }

        .progress-bar.grisha {
            background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
        }

        .progress-bar.liza {
            background: linear-gradient(90deg, #ee0979 0%, #ff6a00 100%);
        }

        .progress-text {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .stats {
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .stats .collected {
            color: #28a745;
            font-weight: 600;
        }

        .stats .remaining {
            color: #dc3545;
        }

        .contributors-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }

        .contributors-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .contributors-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .contributors-table tr:hover {
            background: #f8f9fa;
        }

        .contributors-table .amount {
            font-weight: 600;
            color: #28a745;
        }

        .add-form {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .add-form input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .add-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .add-form input[type="number"] {
            max-width: 120px;
        }

        .add-form button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .add-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .add-form button:active {
            transform: translateY(0);
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 4px 8px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .delete-btn:hover {
            opacity: 1;
        }

        .goal-reached {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 600;
        }

        /* Mobile-first responsive improvements */
        @media (max-width: 480px) {
            body {
                padding: 20px 12px;
            }

            h1 {
                font-size: 1.5rem;
                margin-bottom: 24px;
            }

            .gift-section {
                padding: 16px;
                border-radius: 12px;
                margin-bottom: 20px;
            }

            .gift-title {
                font-size: 1.15rem;
                flex-wrap: wrap;
            }

            .progress-container {
                height: 32px;
            }

            .stats {
                flex-direction: column;
                gap: 4px;
                font-size: 0.85rem;
            }

            .contributors-table th,
            .contributors-table td {
                padding: 8px 6px;
                font-size: 0.9rem;
            }

            .contributors-table th:last-child,
            .contributors-table td:last-child {
                width: 40px;
                text-align: center;
            }

            .add-form {
                flex-direction: column;
            }

            .add-form input {
                padding: 14px 12px;
                font-size: 16px; /* Prevents iOS zoom on focus */
            }

            .add-form input[type="number"] {
                max-width: 100%;
            }

            .add-form button {
                padding: 14px 20px;
                font-size: 16px;
            }

            .delete-btn {
                font-size: 1.4rem;
                padding: 8px 12px;
                min-width: 44px;
                min-height: 44px;
            }

            .empty-state {
                padding: 16px;
                font-size: 0.9rem;
            }

            .goal-reached {
                padding: 10px;
                font-size: 0.9rem;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .delete-btn {
                opacity: 1;
            }

            .add-form button:hover {
                transform: none;
            }

            .add-form button:active {
                transform: scale(0.98);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–°–±–æ—Ä –Ω–∞ –ø–æ–¥–∞—Ä–∫–∏</h1>

        <!-- Grisha Section -->
        <div class="gift-section">
            <div class="gift-title">
                <span class="emoji">üéÅ</span>
                –ü–æ–¥–∞—Ä–æ–∫ –ì—Ä–∏—à–µ ‚Äî 500 ‚Ç¨
            </div>

            <div id="grisha-goal-reached" class="goal-reached" style="display: none;">
                –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!
            </div>

            <div class="progress-container">
                <div class="progress-bar grisha" id="grisha-progress" style="width: 0%;">
                    <span class="progress-text" id="grisha-percent">0%</span>
                </div>
            </div>

            <div class="stats">
                <span>–°–æ–±—Ä–∞–Ω–æ: <span class="collected" id="grisha-collected">0 ‚Ç¨</span></span>
                <span class="remaining">–û—Å—Ç–∞–ª–æ—Å—å: <span id="grisha-remaining">500 ‚Ç¨</span></span>
            </div>

            <table class="contributors-table">
                <thead>
                    <tr>
                        <th>–ò–º—è</th>
                        <th>–°—É–º–º–∞</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="grisha-contributors">
                </tbody>
            </table>
            <div id="grisha-empty" class="empty-state">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –¥–æ–±–∞–≤–∏–ª—Å—è</div>

            <form class="add-form" onsubmit="addContributor('grisha', event)">
                <input type="text" id="grisha-name" placeholder="–í–∞—à–µ –∏–º—è" required>
                <input type="number" id="grisha-amount" placeholder="‚Ç¨" min="1" required>
                <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>
        </div>

        <!-- Liza Section -->
        <div class="gift-section">
            <div class="gift-title">
                <span class="emoji">üéÄ</span>
                –ü–æ–¥–∞—Ä–æ–∫ –õ–∏–∑–µ ‚Äî 100 ‚Ç¨
            </div>

            <div id="liza-goal-reached" class="goal-reached" style="display: none;">
                –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!
            </div>

            <div class="progress-container">
                <div class="progress-bar liza" id="liza-progress" style="width: 0%;">
                    <span class="progress-text" id="liza-percent">0%</span>
                </div>
            </div>

            <div class="stats">
                <span>–°–æ–±—Ä–∞–Ω–æ: <span class="collected" id="liza-collected">0 ‚Ç¨</span></span>
                <span class="remaining">–û—Å—Ç–∞–ª–æ—Å—å: <span id="liza-remaining">100 ‚Ç¨</span></span>
            </div>

            <table class="contributors-table">
                <thead>
                    <tr>
                        <th>–ò–º—è</th>
                        <th>–°—É–º–º–∞</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="liza-contributors">
                </tbody>
            </table>
            <div id="liza-empty" class="empty-state">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –¥–æ–±–∞–≤–∏–ª—Å—è</div>

            <form class="add-form" onsubmit="addContributor('liza', event)">
                <input type="text" id="liza-name" placeholder="–í–∞—à–µ –∏–º—è" required>
                <input type="number" id="liza-amount" placeholder="‚Ç¨" min="1" required>
                <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxCYZ1_6QXOEJrbRhku75Gi_m0bt6TsrchnbBa_RpzTjkElUNDGsO5j5NJQqK5bj5wO/exec';

        const goals = {
            grisha: 500,
            liza: 100
        };

        let data = {
            grisha: [],
            liza: []
        };

        let isLoading = false;

        // Load from Google Sheets
        async function loadData() {
            try {
                showLoading(true);
                const response = await fetch(`${API_URL}?action=get`);
                const result = await response.json();
                console.log('Loaded data:', result);

                // Ensure arrays exist
                data.grisha = result.grisha || [];
                data.liza = result.liza || [];

                updateUI('grisha');
                updateUI('liza');
            } catch (error) {
                console.error('Error loading data:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            isLoading = show;
            document.querySelectorAll('.add-form button').forEach(btn => {
                btn.disabled = show;
                btn.textContent = show ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–î–æ–±–∞–≤–∏—Ç—å';
            });
        }

        // Calculate total for a gift
        function getTotal(gift) {
            return data[gift].reduce((sum, c) => sum + Number(c.amount), 0);
        }

        // Update UI for a gift
        function updateUI(gift) {
            const total = getTotal(gift);
            const goal = goals[gift];
            const percent = Math.min(100, Math.round((total / goal) * 100));
            const remaining = Math.max(0, goal - total);

            // Update progress bar
            const progressBar = document.getElementById(`${gift}-progress`);
            progressBar.style.width = `${Math.max(percent, 8)}%`;
            document.getElementById(`${gift}-percent`).textContent = `${percent}%`;

            // Update stats
            document.getElementById(`${gift}-collected`).textContent = `${total} ‚Ç¨`;
            document.getElementById(`${gift}-remaining`).textContent = `${remaining} ‚Ç¨`;

            // Show goal reached message
            const goalReached = document.getElementById(`${gift}-goal-reached`);
            if (total >= goal) {
                goalReached.style.display = 'block';
            } else {
                goalReached.style.display = 'none';
            }

            // Update table
            const tbody = document.getElementById(`${gift}-contributors`);
            const emptyState = document.getElementById(`${gift}-empty`);

            if (data[gift].length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
                tbody.innerHTML = data[gift].map((c, index) => `
                    <tr>
                        <td>${escapeHtml(c.name)}</td>
                        <td class="amount">${c.amount} ‚Ç¨</td>
                        <td>
                            <button class="delete-btn" onclick="removeContributor('${gift}', ${index})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Add contributor
        async function addContributor(gift, event) {
            event.preventDefault();
            if (isLoading) return;

            const nameInput = document.getElementById(`${gift}-name`);
            const amountInput = document.getElementById(`${gift}-amount`);

            const name = nameInput.value.trim();
            const amount = parseInt(amountInput.value, 10);

            if (name && amount > 0) {
                try {
                    showLoading(true);
                    const params = new URLSearchParams({
                        action: 'add',
                        gift: gift,
                        name: name,
                        amount: amount
                    });

                    await fetch(`${API_URL}?${params}`);

                    nameInput.value = '';
                    amountInput.value = '';
                    nameInput.focus();

                    // Wait for Google Sheets to process
                    await new Promise(r => setTimeout(r, 1500));
                    await loadData();
                } catch (error) {
                    console.error('Error adding contributor:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
                    showLoading(false);
                }
            }
        }

        // Remove contributor
        async function removeContributor(gift, index) {
            if (isLoading) return;
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;

            try {
                showLoading(true);
                const params = new URLSearchParams({
                    action: 'delete',
                    gift: gift,
                    index: index
                });

                await fetch(`${API_URL}?${params}`);
                await new Promise(r => setTimeout(r, 1500));
                await loadData();
            } catch (error) {
                console.error('Error removing contributor:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
                showLoading(false);
            }
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
